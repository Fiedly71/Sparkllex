<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Finance - Sparkllex Admin</title>
    <link rel="icon" type="image/png" href="../images/logo.png">
    
    <script src="../translations.js"></script>
    <script src="../apply-translations.js"></script>
    <script src="../language-selector.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-admin': '#004D4D',
                        'teal-accent': '#008080',
                        'gold-accent': '#D4AF37',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; color: #94a3b8; transition: all 0.2s ease; font-size: 14px; font-weight: 500; }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-item.active { background: #008080; color: white; box-shadow: 0 4px 12px rgba(0,128,128,0.2); }
        .finance-card { background: white; border-radius: 1.5rem; padding: 1.5rem; border: 1px solid rgba(0,0,0,0.05); }
        .chart-bar { transition: height 1s ease-in-out; min-height: 4px; }
        
        @media (max-width: 1023px) {
            aside { 
                position: fixed !important; 
                left: 0; 
                top: 0; 
                transform: translateX(-100%); 
                transition: transform 0.3s ease;
                z-index: 100 !important;
            }
            aside.mobile-open { transform: translateX(0); }
            .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
            .mobile-overlay.active { display: block; }
            body { display: block; }
            main { width: 100% !important; padding: 1rem !important; }
        }
    </style>
</head>
<body class="lg:flex min-h-screen">

    <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-[101] w-12 h-12 bg-teal-accent text-white rounded-xl shadow-lg flex items-center justify-center">
        <i class="fas fa-bars"></i>
    </button>
    
    <div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <aside id="sidebar" class="w-72 bg-teal-admin text-white flex flex-col h-screen shadow-2xl lg:z-50 lg:sticky lg:top-0">
        <div class="p-8 border-b border-white/10">
            <h1 class="text-xl font-black tracking-tighter italic text-center">SPARKLLEX <span class="text-teal-accent">PRO</span></h1>
        </div>
        
        <nav class="flex-1 p-6 space-y-7 overflow-y-auto">
            <div>
                <p class="text-[10px] font-black text-teal-accent uppercase tracking-[2px] mb-4 opacity-70">Operational Control</p>
                <div class="space-y-1">
                    <a href="../03_OPERATIONS/agenda.html" class="sidebar-item">
                        <i class="fas fa-calendar-alt w-5"></i> Global Agenda
                    </a>
                    <a href="../03_OPERATIONS/crm-clients.html" class="sidebar-item">
                        <i class="fas fa-users w-5"></i> CRM Clients
                    </a>
                    <a href="../03_OPERATIONS/team-manager.html" class="sidebar-item">
                        <i class="fas fa-user-shield w-5"></i> Team Manager
                    </a>
                </div>
            </div>

            <div>
                <p class="text-[10px] font-black text-teal-accent uppercase tracking-[2px] mb-4 opacity-70">Global Strategy</p>
                <div class="space-y-1">
                    <a href="./executive-finance.html" class="sidebar-item active">
                        <i class="fas fa-chart-line w-5"></i> Executive Finance
                    </a>
                    <a href="./expansion.html" class="sidebar-item">
                        <i class="fas fa-rocket w-5"></i> Expansion
                    </a>
                </div>
            </div>
        </nav>

        <div class="p-6 border-t border-white/10">
            <button onclick="handleLogout()" class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition font-bold text-sm flex items-center justify-center gap-2">
                <i class="fas fa-power-off"></i> Log Out
            </button>
        </div>
    </aside>

    <main class="flex-1 p-4 lg:p-10 overflow-y-auto bg-[#F8FAFB] pt-20 lg:pt-10">
        <header class="mb-10 flex justify-between items-start">
            <div>
                <h2 class="text-4xl font-black text-slate-900 tracking-tight italic uppercase">Executive Finance</h2>
                <div class="flex items-center gap-3 mt-4 bg-white p-2 rounded-xl border border-gray-100 shadow-sm">
                    <input type="date" id="date-start" class="text-xs font-bold p-1 outline-none">
                    <span class="text-gray-300">to</span>
                    <input type="date" id="date-end" class="text-xs font-bold p-1 outline-none">
                    <button onclick="loadFinanceData()" class="bg-teal-admin text-white px-3 py-2 rounded-lg hover:bg-teal-700 transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportPDF()" class="bg-teal-accent text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-teal-900 transition-all shadow-lg">
                    <i class="fas fa-file-pdf"></i> Export Report
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="finance-card border-l-4 border-teal-accent">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Monthly Recurring (MRR)</p>
                <h3 id="total-revenue" class="text-3xl font-black text-gray-800">$0.00</h3>
            </div>
            <div class="finance-card border-l-4 border-gold-accent">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">New Users (Period)</p>
                <h3 id="total-users" class="text-3xl font-black text-gray-800">0</h3>
            </div>
            <div class="finance-card border-l-4 border-red-400">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Churned Revenue</p>
                <h3 id="churn-revenue" class="text-3xl font-black text-red-500">$0.00</h3>
            </div>
            <div class="finance-card bg-teal-admin text-white">
                <p class="text-[10px] font-black text-teal-accent uppercase tracking-widest mb-1 text-white/40">Annual Run Rate</p>
                <h3 id="annual-revenue" class="text-3xl font-black text-white">$0.00</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 finance-card">
                <h3 class="font-black text-gray-800 text-lg uppercase mb-12">Plan Distribution</h3>
                <div class="flex items-end justify-around gap-4 h-64 border-b border-gray-100 pb-4">
                    <div class="flex flex-col items-center gap-2 w-full">
                        <div id="bar-family" class="chart-bar w-12 bg-gold-accent rounded-t-xl" style="height: 0%"></div>
                        <span class="text-[10px] font-black text-gray-400">FAMILY</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 w-full">
                        <div id="bar-pro" class="chart-bar w-12 bg-teal-accent rounded-t-xl" style="height: 0%"></div>
                        <span class="text-[10px] font-black text-gray-400">PRO</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 w-full">
                        <div id="bar-basic" class="chart-bar w-12 bg-gray-200 rounded-t-xl" style="height: 0%"></div>
                        <span class="text-[10px] font-black text-gray-400">BASIC</span>
                    </div>
                </div>
            </div>

            <div class="finance-card">
                <h3 class="font-black text-gray-800 mb-8 uppercase text-xs text-center">Subscription Mix</h3>
                <div class="space-y-4">
                    <div class="flex justify-between p-4 bg-gray-50 rounded-xl">
                        <span class="text-[10px] font-black">FAMILY</span>
                        <span id="p-percent" class="font-black text-gold-accent">0%</span>
                    </div>
                    <div class="flex justify-between p-4 bg-gray-50 rounded-xl">
                        <span class="text-[10px] font-black">PRO</span>
                        <span id="pro-percent" class="font-black text-teal-accent">0%</span>
                    </div>
                    <div class="flex justify-between p-4 bg-gray-50 rounded-xl">
                        <span class="text-[10px] font-black">BASIC</span>
                        <span id="b-percent" class="font-black text-gray-400">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../database-config.js"></script>
    <script src="../auth-guard.js"></script>
    <script>
        let financialSummary = {};

        window.onload = () => {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('date-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('date-end').value = now.toISOString().split('T')[0];
            checkAdmin();
        };

        function normalizePlan(plan) {
            if (!plan) return 'basic';
            const n = plan.toString().toLowerCase();
            if (n.includes('family') || n.includes('familia')) return 'family';
            if (n.includes('pro')) return 'pro';
            return 'basic';
        }

        async function loadFinanceData() {
            const start = document.getElementById('date-start').value;
            const end = document.getElementById('date-end').value;
            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

            // Fetch Data
            const { data: active } = await supabaseClient.from('profiles').select('plan').eq('role', 'client').eq('plan_status', 'active');
            const { data: period } = await supabaseClient.from('profiles').select('plan').eq('role', 'client').gte('created_at', start).lte('created_at', end + 'T23:59:59');
            const { data: churned } = await supabaseClient.from('profiles').select('plan').eq('role', 'client').eq('plan_status', 'inactive');

            // Logic MRR
            const counts = active.reduce((acc, p) => { acc[normalizePlan(p.plan)]++; return acc; }, { family: 0, pro: 0, basic: 0 });
            const mrr = (counts.family * 249) + (counts.pro * 149) + (counts.basic * 79);
            
            // Logic UI
            document.getElementById('total-revenue').textContent = formatter.format(mrr);
            document.getElementById('annual-revenue').textContent = formatter.format(mrr * 12);
            document.getElementById('total-users').textContent = period.length;
            
            const total = active.length || 1;
            document.getElementById('p-percent').textContent = Math.round((counts.family/total)*100) + '%';
            document.getElementById('pro-percent').textContent = Math.round((counts.pro/total)*100) + '%';
            document.getElementById('b-percent').textContent = Math.round((counts.basic/total)*100) + '%';

            // Bars Height
            const maxVal = Math.max(counts.family, counts.pro, counts.basic) || 1;
            document.getElementById('bar-family').style.height = (counts.family / maxVal * 100) + '%';
            document.getElementById('bar-pro').style.height = (counts.pro / maxVal * 100) + '%';
            document.getElementById('bar-basic').style.height = (counts.basic / maxVal * 100) + '%';

            financialSummary = { mrr, start, end, family: counts.family, pro: counts.pro, basic: counts.basic };
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        async function checkAdmin() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = "../login.html"; return; }
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', session.user.id).single();
            if (profile?.role !== 'admin') { window.location.href = "../login.html"; return; }
            loadFinanceData();
        }

        function handleLogout() {
            secureLogout();
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Executive Financial Report - Sparkllex", 14, 20);
            doc.autoTable({
                startY: 30,
                head: [['Metric', 'Value']],
                body: [
                    ['MRR', `$${financialSummary.mrr}`],
                    ['Family Plans', financialSummary.family],
                    ['Pro Plans', financialSummary.pro],
                    ['Basic Plans', financialSummary.basic]
                ],
            });
            doc.save(`Sparkllex_Finance_${financialSummary.start}.pdf`);
        }

        // Mobile menu event listener
        document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleMobileMenu);
    </script>
</body>
</html>