<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Password - Sparkllex</title>
    <link rel="icon" type="image/png" href="../images/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../database-config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #F4F9F9; min-height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Inter', sans-serif; }
        .card { background: white; border-radius: 2.5rem; box-shadow: 0 25px 50px -12px rgba(0, 128, 128, 0.1); padding: 3rem 2.5rem; max-width: 420px; width: 100%; border: 1px solid rgba(0,128,128,0.05); }
        .premium-input { width: 100%; padding: 1rem 1.25rem; background: #f8fafc; border: 1.5px solid #e2e8f0; border-radius: 1rem; transition: all 0.3s; font-size: 0.9rem; }
        .premium-input:focus { border-color: #008080; background: white; outline: none; box-shadow: 0 0 0 4px rgba(0, 128, 128, 0.1); }
        .password-strength { height: 4px; border-radius: 2px; transition: all 0.3s; margin-top: 8px; }
        .strength-weak { width: 33%; background: #ef4444; }
        .strength-medium { width: 66%; background: #f59e0b; }
        .strength-strong { width: 100%; background: #10b981; }
        .requirement { font-size: 11px; padding: 3px 0; display: flex; align-items: center; gap: 8px; }
        .requirement.met { color: #10b981; }
        .requirement.unmet { color: #94a3b8; }
    </style>
</head>
<body>
    <div class="card">
        <div class="text-center mb-8">
            <img src="../images/logo.png" class="h-8 mx-auto mb-6 opacity-20 grayscale">
            <h1 class="text-2xl font-black text-gray-900 mb-2">Reset your password</h1>
            <p class="text-gray-400 text-sm font-medium">Choose a new secure password</p>
        </div>

        <div id="loading-state" class="text-center py-8">
            <i class="fas fa-circle-notch fa-spin text-teal-600 text-2xl mb-4"></i>
            <p class="text-gray-500 text-sm font-bold">Verifying your reset link...</p>
        </div>

        <div id="error-state" class="hidden text-center py-8">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p class="text-red-500 text-sm font-bold mb-2">Invalid or expired reset link</p>
            <p class="text-gray-400 text-xs mb-6">Please request a new password reset from the login page.</p>
            <a href="../login.html" class="inline-block px-6 py-3 bg-teal-600 text-white font-bold rounded-xl text-xs uppercase tracking-widest hover:bg-teal-700 transition">Back to Login</a>
        </div>

        <form id="reset-form" class="space-y-5 hidden">
            <div>
                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2 ml-1">New Password</label>
                <div class="relative">
                    <input type="password" id="new-password" required class="premium-input" placeholder="Create a strong password">
                    <button type="button" id="togglePassword1" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-teal-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-strength" id="strengthBar"></div>
                <div class="text-xs space-y-1 mt-2 bg-gray-50 p-3 rounded-xl">
                    <div class="requirement unmet" id="req-length"><i class="fas fa-circle text-[6px]"></i> At least 8 characters</div>
                    <div class="requirement unmet" id="req-upper"><i class="fas fa-circle text-[6px]"></i> One uppercase letter</div>
                    <div class="requirement unmet" id="req-lower"><i class="fas fa-circle text-[6px]"></i> One lowercase letter</div>
                    <div class="requirement unmet" id="req-number"><i class="fas fa-circle text-[6px]"></i> One number</div>
                    <div class="requirement unmet" id="req-special"><i class="fas fa-circle text-[6px]"></i> One special character (!@#$%^&*)</div>
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2 ml-1">Confirm Password</label>
                <div class="relative">
                    <input type="password" id="confirm-password" required class="premium-input" placeholder="Confirm your password">
                    <button type="button" id="togglePassword2" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-teal-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="match-msg" class="text-xs mt-2 font-bold hidden"></div>
            </div>

            <button type="submit" id="submit-btn" disabled class="w-full py-4 bg-gray-300 text-white font-black rounded-2xl text-xs uppercase tracking-widest transition-all cursor-not-allowed">
                Update Password
            </button>
        </form>

        <div id="status-msg" class="mt-6 text-center text-sm font-bold"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const resetForm = document.getElementById('reset-form');

            // Supabase gère automatiquement le token dans le hash (#access_token=...)
            // On attend que la session soit récupérée
            const { data: { session }, error } = await supabaseClient.auth.getSession();

            if (!session) {
                // Attendre un peu car Supabase peut prendre du temps à traiter le hash
                await new Promise(resolve => setTimeout(resolve, 1500));
                const retry = await supabaseClient.auth.getSession();
                if (!retry.data.session) {
                    loadingState.classList.add('hidden');
                    errorState.classList.remove('hidden');
                    return;
                }
            }

            // Session valide, afficher le formulaire
            loadingState.classList.add('hidden');
            resetForm.classList.remove('hidden');

            // Password strength validation
            const passwordInput = document.getElementById('new-password');
            const confirmInput = document.getElementById('confirm-password');
            const strengthBar = document.getElementById('strengthBar');
            const submitBtn = document.getElementById('submit-btn');
            const matchMsg = document.getElementById('match-msg');

            function validatePassword(password) {
                const requirements = {
                    length: password.length >= 8,
                    upper: /[A-Z]/.test(password),
                    lower: /[a-z]/.test(password),
                    number: /[0-9]/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                document.getElementById('req-length').className = requirements.length ? 'requirement met' : 'requirement unmet';
                document.getElementById('req-upper').className = requirements.upper ? 'requirement met' : 'requirement unmet';
                document.getElementById('req-lower').className = requirements.lower ? 'requirement met' : 'requirement unmet';
                document.getElementById('req-number').className = requirements.number ? 'requirement met' : 'requirement unmet';
                document.getElementById('req-special').className = requirements.special ? 'requirement met' : 'requirement unmet';

                const metCount = Object.values(requirements).filter(v => v).length;
                strengthBar.className = 'password-strength';
                if (metCount <= 2) strengthBar.classList.add('strength-weak');
                else if (metCount <= 4) strengthBar.classList.add('strength-medium');
                else strengthBar.classList.add('strength-strong');

                return metCount === 5;
            }

            function checkMatch() {
                const pass = passwordInput.value;
                const confirm = confirmInput.value;
                if (confirm.length === 0) {
                    matchMsg.classList.add('hidden');
                    return false;
                }
                matchMsg.classList.remove('hidden');
                if (pass === confirm) {
                    matchMsg.textContent = '✓ Passwords match';
                    matchMsg.className = 'text-xs mt-2 font-bold text-green-600';
                    return true;
                } else {
                    matchMsg.textContent = '✗ Passwords do not match';
                    matchMsg.className = 'text-xs mt-2 font-bold text-red-500';
                    return false;
                }
            }

            function updateSubmitBtn() {
                const strong = validatePassword(passwordInput.value);
                const matching = checkMatch();
                if (strong && matching) {
                    submitBtn.disabled = false;
                    submitBtn.className = 'w-full py-4 bg-teal-600 text-white font-black rounded-2xl text-xs uppercase tracking-widest hover:bg-teal-700 transition-all cursor-pointer';
                } else {
                    submitBtn.disabled = true;
                    submitBtn.className = 'w-full py-4 bg-gray-300 text-white font-black rounded-2xl text-xs uppercase tracking-widest transition-all cursor-not-allowed';
                }
            }

            passwordInput.addEventListener('input', updateSubmitBtn);
            confirmInput.addEventListener('input', updateSubmitBtn);

            // Toggle password visibility
            document.getElementById('togglePassword1').addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                document.getElementById('togglePassword1').querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
            document.getElementById('togglePassword2').addEventListener('click', () => {
                const type = confirmInput.type === 'password' ? 'text' : 'password';
                confirmInput.type = type;
                document.getElementById('togglePassword2').querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });

            // Submit
            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const statusMsg = document.getElementById('status-msg');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Updating...';

                const { error } = await supabaseClient.auth.updateUser({ password: passwordInput.value });
                if (error) {
                    statusMsg.textContent = error.message;
                    statusMsg.className = 'mt-6 text-center text-sm font-bold text-red-500';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Update Password';
                } else {
                    statusMsg.textContent = '✓ Password updated successfully! Redirecting to login...';
                    statusMsg.className = 'mt-6 text-center text-sm font-bold text-green-600';
                    await supabaseClient.auth.signOut();
                    setTimeout(() => window.location.href = '../login.html', 2000);
                }
            });
        });
    </script>
</body>
</html>
