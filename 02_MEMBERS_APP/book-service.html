<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Service - Sparkllex</title>
    <link rel="icon" type="image/png" href="../images/logo.png">
    
    <script src="../translations.js"></script>
    <script src="../apply-translations.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-primary': '#008080',
                        'teal-dark': '#006666',
                        'gold-accent': '#D4AF37',
                        'light-bg': '#F4F9F9',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: radial-gradient(circle at top right, #fdfdfd, #eef6f6);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            scroll-behavior: smooth;
        }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px -15px rgba(0, 80, 80, 0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .service-card:hover {
            border-color: #008080;
            transform: translateY(-8px);
            box-shadow: 0 30px 50px -10px rgba(0, 128, 128, 0.1);
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .sidebar-link.active {
            background: #008080;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 128, 128, 0.2);
        }

        .premium-input {
            width: 100%;
            padding: 14px;
            background: rgba(248, 250, 252, 0.8);
            border: 2px solid transparent;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .premium-input:focus {
            background: white;
            border-color: #008080;
            box-shadow: 0 0 0 4px rgba(0, 128, 128, 0.05);
            outline: none;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #008080 0%, #004d4d 100%);
            transition: all 0.3s ease;
        }
        
        #booking-section.hidden-animation {
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
    </style>
</head>
<body class="text-gray-800">

    <nav class="fixed top-0 left-0 right-0 z-50 backdrop-blur-md bg-white/70 border-b border-teal-primary/10">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <a href="membership-status.html">
                <img src="../images/logo.png" alt="Logo" class="h-14 md:h-16 w-auto">
            </a>
            <div class="flex items-center gap-6">
                <div id="userBadge" class="hidden md:flex items-center gap-3 px-4 py-2 bg-teal-50 rounded-full border border-teal-100">
                    <div class="w-2 h-2 rounded-full bg-teal-primary animate-pulse"></div>
                    <span id="userEmailNav" class="text-[10px] font-black text-teal-primary uppercase tracking-widest">...</span>
                </div>
                <button onclick="handleLogout()" class="text-xs font-black text-red-400 hover:text-red-600 uppercase tracking-widest transition">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="pt-32 pb-12 max-w-7xl mx-auto px-6 flex flex-col lg:flex-row gap-10">
        
        <aside class="w-full lg:w-64 flex-shrink-0">
            <div class="glass-card p-6 rounded-[2rem] sticky top-32">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-teal-primary mb-6 ml-2" data-translate="mainMenu">Men� Principal</p>
                <nav class="space-y-2">
                    <a href="membership-status.html" class="sidebar-link">
                        <i class="fas fa-th-large text-sm"></i> <span data-translate="membershipStatus">Dashboard</span>
                    </a>
                    <a href="book-service.html" class="sidebar-link active">
                        <i class="fas fa-calendar-check text-sm"></i> <span data-translate="booking">Book</span>
                    </a>
                    <a href="appointments.html" class="sidebar-link hover:bg-teal-50 hover:text-teal-primary">
                        <i class="fas fa-list-ul text-sm"></i> <span data-translate="myAppointmentsLink">My Appointments</span>
                    </a>
                    <a href="history.html" class="sidebar-link hover:bg-teal-50 hover:text-teal-primary">
                        <i class="fas fa-history text-sm"></i> <span data-translate="yourHistory">History</span>
                    </a>
                    <a href="support-ia.html" class="sidebar-link hover:bg-teal-50 hover:text-teal-primary">
                        <i class="fas fa-robot text-sm"></i> <span data-translate="aISupportLink">AI Support</span>
                    </a>
                </nav>
            </div>
        </aside>

        <main class="flex-1">
            <header class="mb-12">
                <h1 class="text-4xl font-black text-gray-900 tracking-tight">
                    <span data-translate="selectService">Select your</span> <span class="text-teal-primary" data-translate="bookService">Service</span>
                </h1>
                <p class="text-gray-400 font-medium mt-1" data-translate="personalizeExperience">Personalize your Sparkllex experience today.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                <div class="glass-card service-card group cursor-pointer rounded-[2.5rem] overflow-hidden" onclick="selectService('Deep Cleaning', this)">
                    <div class="h-56 overflow-hidden relative">
                        <img src="../images/cleaning-equipments-arranged-row.jpg" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-teal-900/40 to-transparent"></div>
                    </div>
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-black text-gray-800" data-translate="deepCleaning">Deep Cleaning</h3>
                            <i class="fas fa-plus-circle text-teal-primary group-hover:rotate-90 transition-transform duration-500"></i>
                        </div>
                        <p class="text-sm text-gray-400 font-medium" data-translate="deepCleaningDesc">Professional deep cleaning for your home.</p>
                    </div>
                </div>

                <div class="glass-card service-card group cursor-pointer rounded-[2.5rem] overflow-hidden" onclick="selectService('Elite Laundry', this)">
                    <div class="h-56 overflow-hidden relative">
                        <img src="../images/elite.png" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" style="object-position: 70% 15%;">
                        <div class="absolute inset-0 bg-gradient-to-t from-teal-900/40 to-transparent"></div>
                    </div>
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-black text-gray-800" data-translate="premiumLaundry">Elite Laundry</h3>
                            <i class="fas fa-plus-circle text-teal-primary group-hover:rotate-90 transition-transform duration-500"></i>
                        </div>
                        <p class="text-sm text-gray-400 font-medium" data-translate="highQualityTreatment">High-quality treatment for delicate garments.</p>
                    </div>
                </div>

                <div class="glass-card service-card group cursor-pointer rounded-[2.5rem] overflow-hidden" onclick="selectService('Master Ironing', this)">
                    <div class="h-56 overflow-hidden relative">
                        <img src="../images/positive-female-housekeeper.jpg" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-teal-900/40 to-transparent"></div>
                    </div>
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-black text-gray-800" data-translate="masterIroningLink">Master Ironing</h3>
                            <i class="fas fa-plus-circle text-teal-primary group-hover:rotate-90 transition-transform duration-500"></i>
                        </div>
                        <p class="text-sm text-gray-400 font-medium" data-translate="impeccableFinish">Impeccable finish and professional steaming.</p>
                    </div>
                </div>

                <div class="glass-card service-card group cursor-pointer rounded-[2.5rem] overflow-hidden" onclick="selectService('Maintenance', this)">
                    <div class="h-56 overflow-hidden relative">
                        <img src="../images/reparaciones.jpg" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-teal-900/40 to-transparent"></div>
                    </div>
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-black text-gray-800" data-translate="maintenance">Mantenimiento</h3>
                            <i class="fas fa-plus-circle text-teal-primary group-hover:rotate-90 transition-transform duration-500"></i>
                        </div>
                        <p class="text-sm text-gray-400 font-medium" data-translate="maintenanceDesc">Repairs and technical services for your home.</p>
                    </div>
                </div>
            </div>

            <section id="booking-section" class="hidden-animation transition-all duration-700">
                <div class="glass-card p-10 rounded-[3rem] border-l-8 border-teal-primary relative overflow-hidden">
                    <div class="flex items-center gap-5 mb-10">
                        <div class="w-14 h-14 bg-teal-primary text-white rounded-2xl flex items-center justify-center shadow-lg shadow-teal-primary/20">
                            <i class="fas fa-calendar-check text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-gray-800" data-translate="schedulePickup">Schedule Appointment</h2>
                            <p class="text-xs font-black text-teal-primary uppercase tracking-widest mt-1">Service: <span id="display-service" class="text-gold-accent">---</span></p>
                        </div>
                    </div>

                    <form id="booking-form" class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-6">
                            <div>
                                <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-3 block" data-translate="dateAndTime">Date and time</label>
                                <input type="datetime-local" id="datetime" class="premium-input" required>
                            </div>
                            <div class="p-6 bg-teal-50/50 rounded-2xl border border-teal-100/50">
                                <p class="text-[10px] font-black text-teal-dark uppercase tracking-widest mb-2"><i class="fas fa-info-circle mr-2"></i> Sparkllex Note</p>
                                <p class="text-xs text-teal-primary/80 font-medium" data-translate="pickupTimeNote">Nuestro equipo llegar� en un margen de 30 min respecto a la hora seleccionada.</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-3 block" data-translate="specialInstructions">Instrucciones Especiales</label>
                                <textarea id="notes" rows="4" class="premium-input resize-none" data-translate="notesPlaceholder" placeholder="Ej: Llamar antes de llegar o indicaciones espec�ficas..."></textarea>
                            </div>
                            <button type="submit" id="submitBtn" class="w-full btn-gradient text-white font-black text-[11px] uppercase tracking-[0.2em] py-5 rounded-2xl shadow-xl flex items-center justify-center gap-3">
                                <span data-translate="confirmBooking">Confirmar Reserva</span>
                                <i class="fas fa-arrow-right text-xs"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <div id="success-modal" class="fixed inset-0 bg-teal-900/60 backdrop-blur-md hidden items-center justify-center z-[100] p-6">
        <div class="bg-white rounded-[3rem] p-12 max-w-sm w-full text-center shadow-2xl transition-transform duration-500 scale-90" id="modalContent">
            <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-8 text-3xl animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-800 mb-3" data-translate="bookingSuccess">�Reserva Exitosa!</h3>
            <p class="text-gray-500 font-medium mb-10 text-sm leading-relaxed" data-translate="bookingSuccessMessage">Your appointment has been scheduled. You can view the details in your history.</p>
            <button onclick="goToAppointments()" class="w-full py-5 bg-teal-primary text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-teal-primary/30 hover:bg-teal-dark transition-all">
                <span data-translate="viewMyAppointments">View My Appointments</span>
            </button>
        </div>
    </div>

    <footer class="py-10 text-center text-gray-600 text-[9px] font-bold uppercase tracking-[0.3em] mt-12 border-t border-gray-200">
        <div class="text-[7px] uppercase tracking-[0.3em]">Designed by <a href="https://gui-fiedly.vercel.app" target="_blank" rel="noopener noreferrer" style="color: #008080; text-decoration: underline;" class="hover:opacity-80 transition cursor-pointer">GF Digital Studio</a> | <a href="mailto:isteah.gffilsaime@gmail.com" style="color: #008080; text-decoration: underline;" class="hover:opacity-80 transition cursor-pointer">Gui Fiedly Fils-aime</a></div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../database-config.js"></script>
    <script src="../auth-guard.js"></script>

    <script>
        let selectedServiceName = "";
        let userPlan = "BASIC";
        let currentUserId = null;
        let serviceQuotas = {};

        // Service quotas per plan (by service type)
        const PLAN_QUOTAS = {
            'BASIC': {
                'Deep Cleaning': 1,
                'Elite Laundry': 1,
                'Master Ironing': 1, // Shares with laundry (1 total for laundry OR ironing)
                'Maintenance': 0
            },
            'PRO': {
                'Deep Cleaning': 2,
                'Elite Laundry': 2,
                'Master Ironing': 2, // Shares with laundry (2 total)
                'Maintenance': 1
            },
            'FAMILY': {
                'Deep Cleaning': 4,
                'Elite Laundry': 99, // Fair use
                'Master Ironing': 99, // Fair use
                'Maintenance': 2
            }
        };

        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = "../login.html";
                return;
            }
            currentUserId = user.id;

            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('plan_status, full_name, plan')
                .eq('id', user.id)
                .single();

            if (profile?.plan_status === 'inactive') {
                alert('Your plan is inactive. Please reactivate your subscription.');
                window.location.href = "membership-status.html";
                return;
            }

            userPlan = (profile?.plan || 'BASIC').toUpperCase();

            // Count services used this month by type
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

            const { data: appointments } = await supabaseClient
                .from('appointments')
                .select('service_type')
                .eq('client_id', user.id)
                .gte('appointment_date', firstDayOfMonth)
                .lte('appointment_date', lastDayOfMonth);

            // Count by service type
            serviceQuotas = {
                'Deep Cleaning': 0,
                'Elite Laundry': 0,
                'Master Ironing': 0,
                'Maintenance': 0
            };
            
            (appointments || []).forEach(apt => {
                if (serviceQuotas.hasOwnProperty(apt.service_type)) {
                    serviceQuotas[apt.service_type]++;
                }
            });

            // For Basic plan: Laundry and Ironing share 1 quota
            if (userPlan === 'BASIC') {
                const laundryIroningUsed = serviceQuotas['Elite Laundry'] + serviceQuotas['Master Ironing'];
                serviceQuotas['laundryIroningCombined'] = laundryIroningUsed;
            }
            // For Pro plan: Laundry and Ironing share 2 quota
            if (userPlan === 'PRO') {
                const laundryIroningUsed = serviceQuotas['Elite Laundry'] + serviceQuotas['Master Ironing'];
                serviceQuotas['laundryIroningCombined'] = laundryIroningUsed;
            }

            // Display quota info
            displayQuotaInfo();

            document.getElementById('userEmailNav').textContent = user.email;
            document.getElementById('userBadge').classList.remove('hidden');
        }

        function getServiceLimit(serviceType) {
            const planLimits = PLAN_QUOTAS[userPlan] || PLAN_QUOTAS['BASIC'];
            return planLimits[serviceType] || 0;
        }

        function isServiceAvailable(serviceType) {
            const limit = getServiceLimit(serviceType);
            if (limit >= 99) return true; // Fair use / unlimited
            
            // For Basic/Pro: Laundry and Ironing share quota
            if ((serviceType === 'Elite Laundry' || serviceType === 'Master Ironing') && (userPlan === 'BASIC' || userPlan === 'PRO')) {
                const combinedLimit = userPlan === 'BASIC' ? 1 : 2;
                return serviceQuotas['laundryIroningCombined'] < combinedLimit;
            }
            
            return serviceQuotas[serviceType] < limit;
        }

        function displayQuotaInfo() {
            const planLimits = PLAN_QUOTAS[userPlan] || PLAN_QUOTAS['BASIC'];
            const isFamily = userPlan === 'FAMILY';

            let quotaHtml = `
                <div class="glass-card p-6 rounded-2xl mb-8 border-l-4 border-teal-primary">
                    <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-4">Monthly Service Quota - ${userPlan} Plan</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            `;

            // Cleaning
            const cleaningUsed = serviceQuotas['Deep Cleaning'];
            const cleaningLimit = planLimits['Deep Cleaning'];
            const cleaningExhausted = cleaningUsed >= cleaningLimit;
            quotaHtml += `
                <div class="p-3 rounded-xl ${cleaningExhausted ? 'bg-red-50' : 'bg-teal-50'}">
                    <p class="text-[9px] font-bold text-gray-400 uppercase">Cleaning</p>
                    <p class="text-xl font-black ${cleaningExhausted ? 'text-red-500' : 'text-teal-primary'}">${cleaningUsed}/${cleaningLimit}</p>
                </div>
            `;

            // Laundry/Ironing (combined for Basic/Pro)
            if (userPlan === 'BASIC' || userPlan === 'PRO') {
                const liUsed = serviceQuotas['laundryIroningCombined'];
                const liLimit = userPlan === 'BASIC' ? 1 : 2;
                const liExhausted = liUsed >= liLimit;
                quotaHtml += `
                    <div class="p-3 rounded-xl ${liExhausted ? 'bg-red-50' : 'bg-teal-50'}">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Laundry/Ironing</p>
                        <p class="text-xl font-black ${liExhausted ? 'text-red-500' : 'text-teal-primary'}">${liUsed}/${liLimit}</p>
                    </div>
                `;
            } else {
                // Family plan - fair use
                quotaHtml += `
                    <div class="p-3 rounded-xl bg-teal-50">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Laundry/Ironing</p>
                        <p class="text-xl font-black text-teal-primary">Fair Use</p>
                    </div>
                `;
            }

            // Maintenance
            const maintUsed = serviceQuotas['Maintenance'];
            const maintLimit = planLimits['Maintenance'];
            const maintExhausted = maintUsed >= maintLimit;
            const maintAvailable = maintLimit > 0;
            quotaHtml += `
                <div class="p-3 rounded-xl ${!maintAvailable ? 'bg-gray-100' : maintExhausted ? 'bg-red-50' : 'bg-teal-50'}">
                    <p class="text-[9px] font-bold text-gray-400 uppercase">Repairs</p>
                    <p class="text-xl font-black ${!maintAvailable ? 'text-gray-400' : maintExhausted ? 'text-red-500' : 'text-teal-primary'}">
                        ${maintAvailable ? `${maintUsed}/${maintLimit}` : 'N/A'}
                    </p>
                </div>
            `;

            quotaHtml += `
                    </div>
                    <p class="text-xs text-gray-500 mt-4">⚠️ Fair use policy applies. Resets on the 1st of each month.</p>
                </div>
            `;

            // Insert after header
            const header = document.querySelector('main header');
            const existingQuota = document.getElementById('quota-info');
            if (existingQuota) existingQuota.remove();
            
            const quotaDiv = document.createElement('div');
            quotaDiv.id = 'quota-info';
            quotaDiv.innerHTML = quotaHtml;
            header.after(quotaDiv);

            // Update service cards based on availability
            updateServiceCardsAvailability();
        }

        function updateServiceCardsAvailability() {
            const serviceCards = document.querySelectorAll('.service-card');
            serviceCards.forEach(card => {
                const onclick = card.getAttribute('onclick');
                if (!onclick) return;
                
                const match = onclick.match(/selectService\('([^']+)'/);
                if (!match) return;
                
                const serviceName = match[1];
                const available = isServiceAvailable(serviceName);
                
                if (!available) {
                    card.classList.add('opacity-50');
                    card.style.cursor = 'not-allowed';
                    card.onclick = (e) => {
                        e.preventDefault();
                        alert(`You have used all your ${serviceName} services for this month. Upgrade your plan for more!`);
                    };
                    // Add "Exhausted" badge
                    if (!card.querySelector('.exhausted-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'exhausted-badge absolute top-4 right-4 bg-red-500 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase';
                        badge.textContent = 'Quota Used';
                        card.style.position = 'relative';
                        card.appendChild(badge);
                    }
                }
            });
        }

        checkUser();

        function selectService(serviceName, element) {
            selectedServiceName = serviceName;
            
            document.querySelectorAll('.service-card').forEach(c => {
                c.classList.remove('border-teal-primary', 'ring-4', 'ring-teal-primary/10');
            });
            element.classList.add('border-teal-primary', 'ring-4', 'ring-teal-primary/10');

            const section = document.getElementById('booking-section');
            section.style.display = 'block';
            setTimeout(() => {
                section.classList.remove('hidden-animation');
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);

            document.getElementById('display-service').textContent = serviceName;
        }

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            
            // Double-check quota before submitting
            if (!isServiceAvailable(selectedServiceName)) {
                alert(`You have used all your ${selectedServiceName} services for this month. Please upgrade your plan for more services.`);
                window.location.href = "membership-status.html";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> PROCESSING...';

            const { data: { user } } = await supabaseClient.auth.getUser();
            const pickupDate = document.getElementById('datetime').value;
            const notes = document.getElementById('notes').value;

            // Correction des noms de colonnes selon votre DB Supabase
            const dateTime = new Date(pickupDate);
            const dateString = dateTime.toISOString().split('T')[0]; 
            const timeString = dateTime.toTimeString().slice(0,5);

            const { error } = await supabaseClient
                .from('appointments')
                .insert([
                    { 
                        client_id: user.id,
                        service_type: selectedServiceName, 
                        appointment_date: dateString, // Nom exact DB
                        appointment_time: timeString, // Nom exact DB
                        client_name: user.email,
                        notes: notes,
                        status: 'pendiente'
                    }
                ]);

            if (error) {
                console.error("Supabase Error:", error);
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.textContent = "REINTENTAR";
            } else {
                showSuccess();
            }
        });

        function showSuccess() {
            const modal = document.getElementById('success-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                document.getElementById('modalContent').classList.replace('scale-90', 'scale-100');
            }, 50);
        }

        function goToAppointments() {
            window.location.href = "appointments.html";
        }

        async function handleLogout() {
            secureLogout();
        }
    </script>
</body>
</html>